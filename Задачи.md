Сделаю так:

1. сначала список всех модулей,
2. потом — набор точечных правок, которые почти наверняка снимают кучу текущих ошибок.

---

## 1. Все модули, которые мы уже обсуждали

**A. Session / Auth / Storage**

1. **Модуль A** – `SessionState v2`

   * токен, текущий пользователь
   * Remember Me
   * AES-шифрование токена
   * авто-логин
   * 2FA (login + verify)

2. **Модуль B** – `AutoLoginScreen`

   * экран с “LaBerry / Вход…”
   * автологин через `SessionState.tryAutoLogin()`
   * переход в Auth или Main

3. **Модуль C** – `LoginPanel v2`

   * логин + 2FA
   * чекбокс Remember Me
   * блокировка кнопки при загрузке

4. **Модуль D** – `RegisterPanel v2`

   * регистрация
   * зелёное сообщение об успехе
   * авто-логин после регистрации

---

**B. WebSockets / Presence / Chat**

5. **Модуль E** – `WebSocketPresenceManager v2` + `FriendsState v2`

   * `/ws/presence?token=...`
   * online/offline
   * экспоненциальный reconnect
   * ping/pong
   * `FriendsState.presence`, `setOnline`, `isOnline`

6. **Модуль F** – `WebSocketChatManager v2` 

   * `/ws/chat/{chat_id}?token=...`
   * сообщения
   * typing (отправка)
   * экспоненциальный reconnect
   * ping/pong
   * интеграция с `ChatState.addMessage`

7. **Модуль M** – Typing Indicator

   * `TypingState`
   * обработка входящих `"type": "typing"`
   * `TypingIndicator(chatId)` (“User #id is typing…”)

8. **Модуль N** – System Messages

   * `SystemMessageModel`
   * `ChatEntry` (sealed class: `ChatMessageEntry`, `ChatSystemEntry`)
   * `ChatState.addSystemMessage`
   * `SystemMessageBubble`
   * обработка `"type": "system"` в WS

---

**C. UI / Root / Chat**

9. **Модуль G** – `AppRoot`

   * переключение между AutoLogin / Auth / Main
   * запуск/остановка WS при логине/логауте

10. **Модуль H** – `MainScreen v2`

    * левая колонка (чаты + друзья)
    * центр — чат
    * использование `ChatState`, `FriendsState`, `SessionState`

11. **Модуль J** – Chat UI v2

    * `ChatView`
    * `ChatTopBar`
    * `MessageListView`
    * `MessageBubble` (Discord-стиль)
    * автоскролл
    * формат времени

12. **Модуль K** – ChatList v2

    * `ChatListView`, `ChatListItem`
    * аватарки, превью последнего сообщения, время
    * `ChatState.getUnread(chatId)` + badge

---

**D. Идеи / ещё не реализованные**

13. **Модуль I** – Friends UI v2 (ещё не делали)
14. **Модуль O** – Reactions (ещё не делали)
15. **Модуль P** – Attachments (ещё не делали)
16. **Модуль R/S/...** – DM / Voice и т.п. (только как идея)